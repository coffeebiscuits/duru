<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì±„ê¶Œ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --primary-bg: #f3f5f9;
      --sidebar-bg: #1e293b;
      --accent-color: #6366f1;
      --text-main: #334155;
      --text-sub: #64748b;
    }

    body {
      font-family: 'Pretendard', -apple-system, sans-serif;
      background-color: var(--primary-bg);
      color: var(--text-main);
      letter-spacing: -0.02em;
    }

    .sidebar {
      position: fixed; top: 0; bottom: 0; left: 0;
      width: 260px; padding: 30px 20px;
      background-color: var(--sidebar-bg);
      z-index: 1000; box-shadow: 4px 0 20px rgba(0,0,0,0.05);
    }
    .brand { color: #fff; font-size: 1.4rem; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
    .nav-link {
      color: #94a3b8; font-weight: 500; padding: 14px 16px;
      border-radius: 12px; transition: all 0.2s; margin-bottom: 4px; cursor: pointer;
    }
    .nav-link:hover, .nav-link.active { background-color: rgba(255,255,255,0.1); color: #fff; transform: translateX(4px); }
    
    .main-content { margin-left: 260px; padding: 40px; }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); transition: 0.3s; }
      .main-content { margin-left: 0; padding: 20px; }
    }

    .stat-card { background: #fff; border: none; border-radius: 20px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
    .stat-title { font-size: 0.9rem; color: var(--text-sub); font-weight: 600; margin-bottom: 8px; }
    .stat-value { font-size: 1.6rem; font-weight: 800; color: #0f172a; margin: 0; }
    .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 16px; }
    
    .bg-indigo { background: #e0e7ff; color: #4f46e5; }
    .bg-emerald { background: #dcfce7; color: #16a34a; }
    .bg-rose { background: #ffe4e6; color: #e11d48; }

    .content-box { background: #fff; border-radius: 20px; padding: 30px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.02); margin-top: 30px; }
    
    .table thead th { background: #f8fafc; color: var(--text-sub); font-weight: 600; font-size: 0.85rem; border: none; padding: 15px; }
    .table tbody td { padding: 16px 15px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
    
    .badge-soft { padding: 6px 12px; border-radius: 30px; font-size: 0.75rem; font-weight: 600; }
    .status-done { background: #dcfce7; color: #166534; }
    .status-wait { background: #eff6ff; color: #1e40af; }

    .input-interest { border: none; background: #f8fafc; text-align: right; width: 100%; padding: 8px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; }
    .input-interest:focus { outline: 2px solid var(--accent-color); background: #fff; }

    .hide { display: none !important; }
  </style>
</head>
<body>

  <nav class="sidebar">
    <div class="brand"><span>ì±„ê¶Œ ê´€ë¦¬</span></div>
    <div class="nav flex-column" id="nav-menu">
      <a data-tab="dashboard" class="nav-link active">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
      <a data-tab="list" class="nav-link">ğŸ“¦ ìì‚° ê´€ë¦¬</a>
      <a data-tab="interest" class="nav-link">ğŸ’³ ì´ì ìˆ˜ì·¨</a>
      <a data-tab="analytics" class="nav-link">ğŸ“ˆ ìˆ˜ìµ í†µê³„</a>
    </div>
  </nav>

  <main class="main-content">
    
    <div class="d-flex justify-content-between align-items-center mb-5">
      <div>
        <h2 id="welcome-text" style="font-weight: 800; margin-bottom: 4px;">ì•ˆë…•í•˜ì„¸ìš” ğŸ‘‹</h2>
        <p id="sub-text" style="color: var(--text-sub); margin: 0;">ì˜¤ëŠ˜ì˜ íˆ¬ì í˜„í™©ì…ë‹ˆë‹¤.</p>
      </div>
      <div id="action-buttons"></div>
    </div>

    <div id="render-area"></div>

  </main>

  <div class="modal fade" id="addBondModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius: 24px; border: none; padding: 20px;">
        <div class="modal-header border-0">
          <h5 class="modal-title" style="font-weight: 800;">ìƒˆ ì±„ê¶Œ ë“±ë¡</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="add-bond-form">
          <div class="modal-body space-y-4">
            <div class="mb-3">
              <label class="form-label font-bold small">ì±„ê¶Œëª…</label>
              <input name="name" required class="form-control rounded-3" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì 123">
            </div>
            <div class="row mb-3">
              <div class="col">
                <label class="form-label small">ê´€ë¦¬ ê³„ì¢Œ</label>
                <input name="account" required class="form-control" placeholder="ê³„ì¢Œëª…">
              </div>
              <div class="col">
                <label class="form-label small">ë§¤ë§¤ì´ìœ¨(%)</label>
                <input name="rate" type="number" step="0.01" required class="form-control">
              </div>
            </div>
            <div class="row mb-3">
              <div class="col">
                <label class="form-label small">ë§¤ìˆ˜ì¼</label>
                <input name="buyDate" type="date" required class="form-control">
              </div>
              <div class="col">
                <label class="form-label small">ë§Œê¸°ì¼</label>
                <input name="maturityDate" type="date" required class="form-control">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label small">ë§¤ìˆ˜ê¸ˆì•¡(ì›)</label>
              <input name="buyAmount" type="number" required class="form-control" placeholder="ìˆ«ìë§Œ ì…ë ¥">
            </div>
          </div>
          <div class="modal-footer border-0">
            <button type="submit" class="btn btn-dark w-100 rounded-pill py-3">ë“±ë¡ ì™„ë£Œ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- Data & State ---
    // ê°€ ë°ì´í„°ë¥¼ ì œê±°í•˜ê³  ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
    let bonds = JSON.parse(localStorage.getItem('bond_manager_v4_data')) || [];

    let activeTab = 'dashboard';
    let selectedYear = new Date().getFullYear();
    let searchTerm = '';
    let currentChart = null;

    const formatKRW = (v) => new Intl.NumberFormat('ko-KR').format(v) + 'ì›';
    const saveData = () => localStorage.setItem('bond_manager_v4_data', JSON.stringify(bonds));

    // --- Main Rendering ---
    function render() {
      const area = document.getElementById('render-area');
      const actionArea = document.getElementById('action-buttons');
      area.innerHTML = '';
      actionArea.innerHTML = '';

      if (activeTab === 'dashboard') renderDashboard(area);
      else if (activeTab === 'list') renderList(area, actionArea);
      else if (activeTab === 'interest') renderInterest(area);
      else if (activeTab === 'analytics') renderAnalytics(area);
    }

    function renderDashboard(container) {
      const activeBonds = bonds.filter(b => b.status === 'active');
      const totalInv = activeBonds.reduce((a, c) => a + Number(c.buyAmount), 0);
      let thisYearIncome = 0;
      bonds.forEach(b => {
        const yData = b.interests?.[new Date().getFullYear()];
        if(yData) Object.values(yData).forEach(v => thisYearIncome += (Number(v)||0));
      });

      container.innerHTML = `
        <div class="row g-4">
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-icon bg-indigo">ğŸ’°</div>
              <div class="stat-title">í˜„ì¬ ì´ íˆ¬ì ì›ê¸ˆ</div>
              <h3 class="stat-value">${formatKRW(totalInv)}</h3>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-icon bg-emerald">ğŸ’</div>
              <div class="stat-title">${new Date().getFullYear()}ë…„ ì˜ˆìƒ ì´ì</div>
              <h3 class="stat-value">${formatKRW(thisYearIncome)}</h3>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-icon bg-rose">ğŸ“¦</div>
              <div class="stat-title">ìš´ìš© ì¢…ëª© ìˆ˜</div>
              <h3 class="stat-value">${activeBonds.length} ê°œ</h3>
            </div>
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-lg-8">
            <div class="content-box">
              <h5 style="font-weight: 700; margin-bottom: 20px;">ìì‚° ë¹„ì¤‘ (Top 5)</h5>
              <canvas id="dashChart" height="120"></canvas>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="content-box">
              <h5 style="font-weight: 700; margin-bottom: 20px;">ìµœê·¼ ë“±ë¡ ìì‚°</h5>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead><tr><th>ìì‚°ëª…</th><th>ìƒíƒœ</th></tr></thead>
                  <tbody>
                    ${bonds.length === 0 ? '<tr><td colspan="2" class="text-center py-4 text-muted small">ë“±ë¡ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>' : 
                      bonds.slice(-4).reverse().map(b => `
                      <tr>
                        <td class="small font-bold">${b.name}</td>
                        <td><span class="badge-soft ${b.status==='active'?'status-wait':'status-done'}">${b.status==='active'?'ë³´ìœ ì¤‘':'ì™„ë£Œ'}</span></td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;

      const ctx = document.getElementById('dashChart').getContext('2d');
      if(currentChart) currentChart.destroy();
      currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: activeBonds.slice(0, 5).map(b => b.name),
          datasets: [{ data: activeBonds.slice(0, 5).map(b => b.buyAmount), backgroundColor: '#6366f1', borderRadius: 10 }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } } }
      });
    }

    function renderList(container, actionArea) {
      actionArea.innerHTML = `<button class="btn btn-dark rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addBondModal">+ ìƒˆ ìì‚° ë“±ë¡</button>`;
      
      container.innerHTML = `
        <div class="content-box mt-0">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 style="font-weight: 700; margin: 0;">ì „ì²´ ì±„ê¶Œ í¬íŠ¸í´ë¦¬ì˜¤</h5>
            <input type="text" id="listSearch" oninput="handleSearch(this.value)" placeholder="ê²€ìƒ‰..." class="form-control form-control-sm w-auto rounded-pill px-3" value="${searchTerm}">
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ì±„ê¶Œëª…</th>
                  <th>ê³„ì¢Œ</th>
                  <th>ë§¤ìˆ˜ê¸ˆì•¡</th>
                  <th>ì´ìœ¨</th>
                  <th>ë§Œê¸°ì¼</th>
                  <th>ìƒíƒœ</th>
                  <th>ê´€ë¦¬</th>
                </tr>
              </thead>
              <tbody>
                ${bonds.length === 0 ? '<tr><td colspan="7" class="text-center py-5 text-muted">ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒˆ ìì‚°ì„ ë“±ë¡í•˜ì„¸ìš”.</td></tr>' :
                  bonds.filter(b => b.name.toLowerCase().includes(searchTerm.toLowerCase())).reverse().map(b => `
                  <tr>
                    <td class="font-bold">${b.name}</td>
                    <td class="text-secondary">${b.account}</td>
                    <td class="font-bold">${formatKRW(b.buyAmount)}</td>
                    <td class="text-primary font-bold">${b.rate}%</td>
                    <td class="text-secondary">${b.maturityDate}</td>
                    <td><span class="badge-soft ${b.status==='active'?'status-wait':'status-done'}">${b.status==='active'?'ë³´ìœ ì¤‘':'ìƒí™˜ì™„ë£Œ'}</span></td>
                    <td>
                      <div class="btn-group">
                        ${b.status==='active' ? `<button onclick="toggleStatus(${b.id})" class="btn btn-sm btn-outline-success border-0">âœ”ï¸</button>` : ''}
                        <button onclick="deleteBond(${b.id})" class="btn btn-sm btn-outline-danger border-0">ğŸ—‘ï¸</button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderInterest(container) {
      container.innerHTML = `
        <div class="content-box mt-0 overflow-hidden">
          <div class="d-flex gap-3 align-items-center mb-4">
             <select onchange="changeYear(this.value)" class="form-select w-auto rounded-pill border-0 bg-light font-bold">
                ${[2024, 2025, 2026, 2027, 2028].map(y => `<option value="${y}" ${selectedYear==y?'selected':''}>${y}ë…„ ë°ì´í„°</option>`).join('')}
             </select>
             <p class="text-secondary m-0 small">â€» ì›”ë³„ ìˆ˜ë ¹í•˜ì‹  ì´ì ê¸ˆì•¡ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</p>
          </div>
          <div class="table-responsive" style="max-height: 600px;">
            <table class="table table-sm text-center">
              <thead class="sticky-top">
                <tr>
                  <th class="text-start">ìì‚°ëª…</th>
                  <th class="bg-indigo text-white">í•©ê³„</th>
                  ${Array.from({length:12}).map((_, i) => `<th>${i+1}ì›”</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${bonds.length === 0 ? '<tr><td colspan="14" class="text-center py-5 text-muted">ì´ì ë°ì´í„°ë¥¼ ê´€ë¦¬í•  ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>' :
                  bonds.map(b => {
                  const yData = b.interests?.[selectedYear] || {};
                  const rowTotal = Object.values(yData).reduce((a,b)=>a+(Number(b)||0), 0);
                  return `
                    <tr>
                      <td class="text-start font-bold small" style="min-width:180px">${b.name}</td>
                      <td class="bg-light font-bold">${rowTotal.toLocaleString()}</td>
                      ${Array.from({length:12}).map((_, i) => `
                        <td style="min-width:80px">
                          <input type="number" value="${yData[i+1]||''}" 
                            onchange="updateInterest(${b.id}, ${selectedYear}, ${i+1}, this.value)"
                            class="input-interest">
                        </td>
                      `).join('')}
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderAnalytics(container) {
      const totalLife = bonds.reduce((a, c) => a + Number(c.buyAmount), 0);
      let totalProfit = 0;
      bonds.forEach(b => Object.values(b.interests || {}).forEach(y => Object.values(y).forEach(v => totalProfit += (Number(v)||0))));

      const monthlyData = Array(12).fill(0).map((_, i) => {
        let sum = 0;
        bonds.forEach(b => sum += (Number(b.interests?.[selectedYear]?.[i+1]) || 0));
        return sum;
      });

      container.innerHTML = `
        <div class="row g-4">
          <div class="col-md-6">
            <div class="stat-card">
              <div class="stat-title">ëˆ„ì  ì´ íˆ¬ì (ì—­ëŒ€ í•©ì‚°)</div>
              <h3 class="stat-value">${formatKRW(totalLife)}</h3>
            </div>
          </div>
          <div class="col-md-6">
            <div class="stat-card">
              <div class="stat-title text-emerald">ëˆ„ì  ì´ì ìˆ˜ìµ</div>
              <h3 class="stat-value text-emerald">${formatKRW(totalProfit)}</h3>
            </div>
          </div>
        </div>
        <div class="content-box">
          <h5 style="font-weight: 700; margin-bottom: 20px;">${selectedYear}ë…„ ì›”ë³„ ìˆ˜ìµ íë¦„</h5>
          <canvas id="anaChart" height="100"></canvas>
        </div>
      `;

      const ctx = document.getElementById('anaChart').getContext('2d');
      let gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
      gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

      if(currentChart) currentChart.destroy();
      currentChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({length:12}, (_, i) => `${i+1}ì›”`),
          datasets: [{
            data: monthlyData, borderColor: '#6366f1', backgroundColor: gradient,
            fill: true, tension: 0.4, borderWidth: 3, pointRadius: 4
          }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    // --- Actions ---
    window.toggleStatus = (id) => {
      bonds = bonds.map(b => b.id === id ? {...b, status: 'completed'} : b);
      saveData(); render();
    };

    window.deleteBond = (id) => {
      if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        bonds = bonds.filter(b => b.id !== id);
        saveData(); render();
      }
    };

    window.updateInterest = (id, year, month, val) => {
      bonds = bonds.map(b => {
        if(b.id === id) {
          if(!b.interests) b.interests = {};
          if(!b.interests[year]) b.interests[year] = {};
          b.interests[year][month] = val;
        }
        return b;
      });
      saveData(); render();
    };

    window.handleSearch = (val) => { searchTerm = val; render(); };
    window.changeYear = (val) => { selectedYear = val; render(); };

    document.getElementById('nav-menu').addEventListener('click', (e) => {
      if(e.target.dataset.tab) {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        e.target.classList.add('active');
        activeTab = e.target.dataset.tab;
        render();
      }
    });

    document.getElementById('add-bond-form').onsubmit = (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      bonds.push({
        id: Date.now(),
        name: fd.get('name'),
        account: fd.get('account'),
        buyDate: fd.get('buyDate'),
        maturityDate: fd.get('maturityDate'),
        rate: fd.get('rate'),
        buyAmount: Number(fd.get('buyAmount')),
        status: 'active',
        interests: {}
      });
      saveData();
      const modalElement = document.getElementById('addBondModal');
      const modalInstance = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
      modalInstance.hide();
      render();
      e.target.reset();
    };

    render();
  </script>
</body>
</html>
